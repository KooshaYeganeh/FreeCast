#!/bin/bash
set -e

# ===================
# Colors
# ===================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# ===================
# Required binary and service config
# ===================
REQUIRED_PYTHON="python3.11"
REQUIRED_PACKAGES=("python3.11-venv")
EXPECTED_PACKAGE_COUNT=27
SERVICE_FILE="FMhost.service"
SERVICE_PATH="/etc/systemd/system/FMhost.service"

# ===================
# Functions
# ===================
function error_exit {
    echo -e "${RED}Error:$1${NC}"
    exit 1
}

# ===================
# 1) Check Python & required packages
# ===================
echo -e "${YELLOW}Checking Python and system packages...${NC}"
if ! command -v $REQUIRED_PYTHON &> /dev/null; then
    error_exit "$REQUIRED_PYTHON is not installed. Please install python3.11 first."
fi

for pkg in "${REQUIRED_PACKAGES[@]}"; do
    if ! dpkg -s "$pkg" &> /dev/null; then
        error_exit "$pkg is not installed. Run 'sudo apt install $pkg'"
    fi
done
echo -e "${GREEN}Python and required system packages OK.${NC}"

# ===================
# 2) Create + activate venv
# ===================
echo -e "${YELLOW}Setting up Python virtual environment...${NC}"
if [ ! -d "venv" ]; then
    $REQUIRED_PYTHON -m venv venv
    echo -e "${GREEN}Venv created.${NC}"
else
    echo -e "${YELLOW}Venv already exists.${NC}"
fi

source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# ===================
# 3) Verify installed package count
# ===================
INSTALLED_COUNT=$(pip freeze | wc -l)
if [ "$INSTALLED_COUNT" -ne "$EXPECTED_PACKAGE_COUNT" ]; then
    echo -e "${RED}Warning: expected ~${EXPECTED_PACKAGE_COUNT} python packages but found ${INSTALLED_COUNT}.${NC}"
fi
deactivate

# ===================
# 4) Install IPTV player
# ===================
echo -e "${YELLOW}Installing IPTV player...${NC}"

# Option A: Hypnotix (simple M3U/IPTV player)
if ! command -v hypnotix &> /dev/null; then
    echo -e "${YELLOW}Installing Hypnotix...${NC}"
    sudo apt update
    sudo apt install -y hypnotix libmpv1 libmysqlclient-dev || \
        error_exit "Failed to install Hypnotix. Try installing manually."
    echo -e "${GREEN}Hypnotix installed.${NC}"
else
    echo -e "${GREEN}Hypnotix is already installed.${NC}"
fi

# Alternatively Option B: Kodi + PVR IPTV Simple Client
# Check if user wants Kodi override
read -p "Install Kodi + IPTV plugin instead? (y/N): " INSTALL_KODI
if [[ "$INSTALL_KODI" =~ ^[Yy]$ ]]; then
    echo -e "${YELLOW}Installing Kodi and PVR IPTV Simple Client...${NC}"
    sudo apt install -y kodi kodi-pvr-iptvsimple || error_exit "Kodi install failed"
    echo -e "${GREEN}Kodi + IPTV Simple Client installed.${NC}"
    echo -e "${YELLOW}NOTE: You must enable and configure the PVR addon from Kodi UI.${NC}"
fi

# ===================
# 5) Place example IPTV config
# ===================
IPTV_CONFIG_DIR="$HOME/iptv"
echo -e "${YELLOW}Setting up IPTV config directory at ${IPTV_CONFIG_DIR}...${NC}"
mkdir -p "$IPTV_CONFIG_DIR"

cat > "$IPTV_CONFIG_DIR/README.txt" <<EOF
This directory holds example IPTV configuration data.

1) If using Hypnotix:
   - Open Hypnotix,
   - Choose "Add Provider",
   - Enter a name and your M3U URL or Xtream Codes API details.

2) If using Kodi:
   - Open Kodi,
   - Go to Add-ons -> My Add-ons -> PVR Clients -> IPTV Simple Client,
   - Configure with your M3U URL and (if provided) EPG URLs.
EOF
echo -e "${GREEN}IPTV config instructions placed in ${IPTV_CONFIG_DIR}.${NC}"

# ===================
# 6) systemd service setup
# ===================
echo -e "${YELLOW}Configuring systemd service...${NC}"
if [ ! -f "$SERVICE_FILE" ]; then
    error_exit "Service file $SERVICE_FILE not found in current directory."
fi

sudo cp "$SERVICE_FILE" "$SERVICE_PATH"
sudo systemctl daemon-reload
sudo systemctl enable FMhost.service
sudo systemctl start FMhost.service || \
    error_exit "Failed to start FMhost.service"

echo -e "${GREEN}FMhost.service started.${NC}"
echo -e "${YELLOW}Check status with: systemctl status FMhost.service${NC}"

echo -e "${GREEN}IPTV setup complete.${NC}"
exit 0

