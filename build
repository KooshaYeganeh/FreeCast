#!/bin/bash

# Exit on error
set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuration
APP_NAME="fmhost"
VERSION="1.0.0"
ARCHITECTURE="amd64"
MAINTAINER="Koosha Yeganeh <kooshakooshadv@gmail.com>"
DESCRIPTION="Video Hosting Platform - Convert your old PC into a media server"
DEPENDENCIES="python3.11, python3.11-venv, python3-pip, mysql-server, nginx, ffmpeg"

# Create directory structure
echo -e "${YELLOW}Creating DEB package structure...${NC}"
PACKAGE_DIR="${APP_NAME}_${VERSION}_${ARCHITECTURE}"
BUILD_DIR="deb_build"

# Clean up previous builds
rm -rf "$BUILD_DIR" "$PACKAGE_DIR.deb"
mkdir -p "$BUILD_DIR/$PACKAGE_DIR"

# Create DEBIAN control directory
mkdir -p "$BUILD_DIR/$PACKAGE_DIR/DEBIAN"

# Create application directories
mkdir -p "$BUILD_DIR/$PACKAGE_DIR/opt/$APP_NAME"
mkdir -p "$BUILD_DIR/$PACKAGE_DIR/etc/systemd/system"
mkdir -p "$BUILD_DIR/$PACKAGE_DIR/usr/local/bin"
mkdir -p "$BUILD_DIR/$PACKAGE_DIR/var/log/$APP_NAME"
mkdir -p "$BUILD_DIR/$PACKAGE_DIR/var/lib/$APP_NAME"
mkdir -p "$BUILD_DIR/$PACKAGE_DIR/etc/nginx/sites-available"
mkdir -p "$BUILD_DIR/$PACKAGE_DIR/usr/share/doc/$APP_NAME"

# Copy application files
echo -e "${YELLOW}Copying application files...${NC}"
cp -r app/ "$BUILD_DIR/$PACKAGE_DIR/opt/$APP_NAME/"
cp -r static/ "$BUILD_DIR/$PACKAGE_DIR/opt/$APP_NAME/"
cp -r templates/ "$BUILD_DIR/$PACKAGE_DIR/opt/$APP_NAME/" 2>/dev/null || true
cp requirements.txt "$BUILD_DIR/$PACKAGE_DIR/opt/$APP_NAME/"
cp README.md "$BUILD_DIR/$PACKAGE_DIR/opt/$APP_NAME/"
cp LICENSE "$BUILD_DIR/$PACKAGE_DIR/opt/$APP_NAME/"
cp Documents/create_your_media_server.md "$BUILD_DIR/$PACKAGE_DIR/opt/$APP_NAME/" 2>/dev/null || true

# Copy and modify service file
echo -e "${YELLOW}Setting up service files...${NC}"
cp FMhost.service "$BUILD_DIR/$PACKAGE_DIR/opt/$APP_NAME/"
# Update service file paths for installation
sed -i 's|/home/koosha/w/FMhost|/opt/fmhost|g' "$BUILD_DIR/$PACKAGE_DIR/opt/$APP_NAME/FMhost.service"
cp "$BUILD_DIR/$PACKAGE_DIR/opt/$APP_NAME/FMhost.service" "$BUILD_DIR/$PACKAGE_DIR/etc/systemd/system/"

# Copy and modify runner script
echo -e "${YELLOW}Setting up runner scripts...${NC}"
cp FMhost_runner "$BUILD_DIR/$PACKAGE_DIR/opt/$APP_NAME/"
sed -i 's|/home/$USER/w/FMhost|/opt/fmhost|g' "$BUILD_DIR/$PACKAGE_DIR/opt/$APP_NAME/FMhost_runner"
sed -i 's|cd app|cd /opt/fmhost/app|g' "$BUILD_DIR/$PACKAGE_DIR/opt/$APP_NAME/FMhost_runner"
chmod +x "$BUILD_DIR/$PACKAGE_DIR/opt/$APP_NAME/FMhost_runner"
cp "$BUILD_DIR/$PACKAGE_DIR/opt/$APP_NAME/FMhost_runner" "$BUILD_DIR/$PACKAGE_DIR/usr/local/bin/fmhost-runner"

# Create control file
echo -e "${YELLOW}Creating control file...${NC}"
cat > "$BUILD_DIR/$PACKAGE_DIR/DEBIAN/control" << EOF
Package: $APP_NAME
Version: $VERSION
Architecture: $ARCHITECTURE
Maintainer: $MAINTAINER
Depends: $DEPENDENCIES
Recommends: mysql-client, python3-dev, build-essential
Section: web
Priority: optional
Description: $DESCRIPTION
 FMhost is a self-hosted video streaming platform that converts any old PC
 into a fully functional media server. It features video uploading, organization,
 streaming, and management through a web interface.
EOF

# Create post-installation script
echo -e "${YELLOW}Creating post-installation script...${NC}"
cat > "$BUILD_DIR/$PACKAGE_DIR/DEBIAN/postinst" << 'EOF'
#!/bin/bash
set -e

# Create necessary directories
mkdir -p /var/log/fmhost
mkdir -p /var/lib/fmhost/media
mkdir -p /var/lib/fmhost/covers
mkdir -p /var/lib/fmhost/thumbnails
chmod 755 /var/log/fmhost
chmod 755 /var/lib/fmhost

# Create fmhost user if it doesn't exist
if ! id -u fmhost >/dev/null 2>&1; then
    useradd -r -s /bin/bash -m -d /opt/fmhost fmhost
fi

# Set ownership
chown -R fmhost:fmhost /opt/fmhost
chown -R fmhost:fmhost /var/log/fmhost
chown -R fmhost:fmhost /var/lib/fmhost

# Setup Python virtual environment
echo "Setting up Python virtual environment..."
cd /opt/fmhost
if [ ! -d "venv" ]; then
    python3.11 -m venv venv
fi

# Activate venv and install requirements
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
deactivate

# Setup database
echo "Setting up database..."
if command -v mysql &> /dev/null; then
    mysql -e "CREATE DATABASE IF NOT EXISTS kygnus_video_library;" || true
    mysql -e "CREATE USER IF NOT EXISTS 'koosha'@'localhost' IDENTIFIED BY 'K102030k';" || true
    mysql -e "GRANT ALL PRIVILEGES ON kygnus_video_library.* TO 'koosha'@'localhost';" || true
    mysql -e "FLUSH PRIVILEGES;" || true
fi

# Setup nginx configuration if nginx is installed
if command -v nginx &> /dev/null; then
    cat > /etc/nginx/sites-available/fmhost << NGINXCONF
server {
    listen 80;
    server_name _;
    
    location / {
        proxy_pass http://127.0.0.1:5005;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
    
    location /static {
        alias /opt/fmhost/static;
        expires 30d;
    }
}
NGINXCONF
    
    # Enable site if not already enabled
    if [ ! -f /etc/nginx/sites-enabled/fmhost ]; then
        ln -sf /etc/nginx/sites-available/fmhost /etc/nginx/sites-enabled/
    fi
    
    # Test and reload nginx
    nginx -t && systemctl reload nginx
fi

# Enable and start service
systemctl daemon-reload
systemctl enable fmhost.service
systemctl start fmhost.service

echo "FMhost installation completed successfully!"
echo "Access your media server at: http://$(hostname -I | awk '{print $1}'):5005"
echo "Or through nginx at: http://$(hostname -I | awk '{print $1}')"
EOF

# Create pre-removal script
cat > "$BUILD_DIR/$PACKAGE_DIR/DEBIAN/prerm" << 'EOF'
#!/bin/bash
set -e

# Stop service before removal
systemctl stop fmhost.service || true
systemctl disable fmhost.service || true
EOF

# Create post-removal script
cat > "$BUILD_DIR/$PACKAGE_DIR/DEBIAN/postrm" << 'EOF'
#!/bin/bash
set -e

# Clean up nginx configuration
if [ -f /etc/nginx/sites-enabled/fmhost ]; then
    rm -f /etc/nginx/sites-enabled/fmhost
fi
if [ -f /etc/nginx/sites-available/fmhost ]; then
    rm -f /etc/nginx/sites-available/fmhost
fi

# Remove user if created by package
if id -u fmhost >/dev/null 2>&1; then
    userdel fmhost 2>/dev/null || true
fi

# Clean up directories (only if empty)
rmdir /var/log/fmhost 2>/dev/null || true
rmdir /var/lib/fmhost 2>/dev/null || true

# Reload nginx if installed
if command -v nginx &> /dev/null; then
    nginx -t && systemctl reload nginx 2>/dev/null || true
fi

systemctl daemon-reload
EOF

# Make scripts executable
chmod 755 "$BUILD_DIR/$PACKAGE_DIR/DEBIAN/postinst"
chmod 755 "$BUILD_DIR/$PACKAGE_DIR/DEBIAN/prerm"
chmod 755 "$BUILD_DIR/$PACKAGE_DIR/DEBIAN/postrm"

# Create changelog
echo -e "${YELLOW}Creating documentation...${NC}"
cat > "$BUILD_DIR/$PACKAGE_DIR/usr/share/doc/$APP_NAME/changelog.Debian" << EOF
fmhost ($VERSION) stable; urgency=medium

  * Initial release of FMhost Video Hosting Platform
  * Features include:
    - Video uploading and management
    - Web-based streaming interface
    - Automatic thumbnail generation
    - MySQL database backend
    - Systemd service integration

 -- $MAINTAINER  $(date -R)
EOF

gzip -9 "$BUILD_DIR/$PACKAGE_DIR/usr/share/doc/$APP_NAME/changelog.Debian"

# Create copyright file
cat > "$BUILD_DIR/$PACKAGE_DIR/usr/share/doc/$APP_NAME/copyright" << EOF
Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
Upstream-Name: FMhost
Source: https://github.com/KooshaYeganeh/FMhost

Files: *
Copyright: $(date +%Y) $MAINTAINER
License: MIT

License: MIT
 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:
 .
 The above copyright notice and this permission notice shall be included in all
 copies or substantial portions of the Software.
 .
 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 SOFTWARE.
EOF

# Create README
cat > "$BUILD_DIR/$PACKAGE_DIR/usr/share/doc/$APP_NAME/README.Debian" << EOF
FMhost Debian Package
=====================

This package installs FMhost, a self-hosted video streaming platform.

After installation:
1. Access the web interface at: http://your-server-ip:5005
2. Default database credentials are in /opt/fmhost/app/config.py
3. Service runs as user 'fmhost'
4. Logs are available in /var/log/fmhost/
5. Media files should be placed in /var/lib/fmhost/media/

To manage the service:
  sudo systemctl status fmhost
  sudo systemctl start fmhost
  sudo systemctl stop fmhost
  sudo systemctl restart fmhost

For more information, visit:
https://github.com/KooshaYeganeh/FMhost
EOF

# Build the package
echo -e "${YELLOW}Building DEB package...${NC}"
dpkg-deb --build "$BUILD_DIR/$PACKAGE_DIR" "${APP_NAME}_${VERSION}_${ARCHITECTURE}.deb"

# Verify the package
echo -e "${YELLOW}Verifying package...${NC}"
dpkg -c "${APP_NAME}_${VERSION}_${ARCHITECTURE}.deb" > /dev/null
dpkg -I "${APP_NAME}_${VERSION}_${ARCHITECTURE}.deb" > /dev/null

echo -e "${GREEN}âœ… DEB package created successfully: ${APP_NAME}_${VERSION}_${ARCHITECTURE}.deb${NC}"
echo ""
echo -e "${YELLOW}To install:${NC}"
echo "  sudo dpkg -i ${APP_NAME}_${VERSION}_${ARCHITECTURE}.deb"
echo ""
echo -e "${YELLOW}If there are dependency issues:${NC}"
echo "  sudo apt-get install -f"
echo ""
echo -e "${YELLOW}To remove:${NC}"
echo "  sudo dpkg -r fmhost"
