{% extends "base.html" %}

{% block title %}Manage IPTV Channels - KYGNus FreeCast{% endblock %}

{% block extra_css %}
<style>
    /* IPTV Management Specific Styles */
    .channel-card {
        background-color: var(--youtube-light-dark);
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.3s ease;
        border: 1px solid #404040;
    }
    
    .channel-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        border-color: var(--youtube-red);
    }
    
    .channel-logo-container {
        width: 100%;
        height: 140px;
        background-color: #202020;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }
    
    .channel-logo {
        max-width: 80%;
        max-height: 80%;
        object-fit: contain;
    }
    
    .channel-status {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid var(--youtube-dark);
    }
    
    .channel-status.live {
        background-color: #00ff00;
        box-shadow: 0 0 10px #00ff00;
    }
    
    .channel-status.offline {
        background-color: #ff0000;
    }
    
    .channel-info {
        padding: 15px;
    }
    
    .channel-name {
        color: white;
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 8px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .channel-category {
        display: inline-block;
        background-color: var(--youtube-red);
        color: white;
        padding: 3px 10px;
        border-radius: 15px;
        font-size: 12px;
        margin-bottom: 10px;
    }
    
    .channel-meta {
        font-size: 13px;
        color: var(--youtube-text-secondary);
    }
    
    .channel-actions {
        display: flex;
        gap: 5px;
        margin-top: 15px;
    }
    
    .channel-action-btn {
        flex: 1;
        padding: 6px;
        font-size: 12px;
        border-radius: 5px;
        border: none;
        transition: all 0.2s;
    }
    
    .channel-action-btn:hover {
        opacity: 0.9;
    }
    
    .play-btn {
        background-color: var(--youtube-red);
        color: white;
    }
    
    .edit-btn {
        background-color: #1C62B9;
        color: white;
    }
    
    .delete-btn {
        background-color: #dc3545;
        color: white;
    }
    
    /* Form Styles */
    .channel-form-section {
        background-color: var(--youtube-light-dark);
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 30px;
    }
    
    .form-title {
        color: white;
        font-size: 20px;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #404040;
    }
    
    .form-label {
        color: var(--youtube-text);
        font-weight: 500;
    }
    
    /* Tabs */
    .nav-tabs {
        border-bottom: 1px solid #404040;
        margin-bottom: 20px;
    }
    
    .nav-tabs .nav-link {
        color: var(--youtube-text-secondary);
        border: none;
        background: none;
        padding: 10px 20px;
        font-weight: 500;
    }
    
    .nav-tabs .nav-link:hover {
        color: white;
        border: none;
    }
    
    .nav-tabs .nav-link.active {
        color: var(--youtube-red);
        background: none;
        border: none;
        border-bottom: 3px solid var(--youtube-red);
    }
    
    /* Statistics Cards */
    .stats-card {
        background-color: var(--youtube-light-dark);
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        border-left: 4px solid var(--youtube-red);
        margin-bottom: 20px;
    }
    
    .stats-icon {
        font-size: 30px;
        margin-bottom: 15px;
        color: var(--youtube-red);
    }
    
    .stats-number {
        font-size: 32px;
        font-weight: bold;
        color: white;
        margin-bottom: 5px;
    }
    
    .stats-label {
        color: var(--youtube-text-secondary);
        font-size: 14px;
    }
    
    /* M3U Section */
    .m3u-section {
        background-color: var(--youtube-light-dark);
        padding: 20px;
        border-radius: 10px;
        margin-top: 30px;
    }
    
    .m3u-info {
        background-color: #121212;
        padding: 15px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 14px;
        color: var(--youtube-text);
        margin-bottom: 15px;
    }
    
    /* Bulk Import Section */
    .bulk-import-section {
        background-color: var(--youtube-light-dark);
        padding: 20px;
        border-radius: 10px;
        margin-top: 30px;
    }
    
    .instructions {
        background-color: #121212;
        padding: 15px;
        border-radius: 5px;
        font-size: 14px;
        color: var(--youtube-text-secondary);
        margin-bottom: 20px;
    }
    
    .code-block {
        background-color: #000;
        color: #00ff00;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 13px;
        overflow-x: auto;
        margin: 10px 0;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .channel-card {
            margin-bottom: 20px;
        }
        
        .channel-form-section {
            padding: 15px;
        }
        
        .channel-actions {
            flex-direction: column;
        }
        
        .channel-action-btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 style="color: white; font-weight: 600;">IPTV Channel Management</h1>
        <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#addChannelModal">
            <i class="fas fa-plus me-2"></i>Add Channel
        </button>
    </div>

    <!-- Statistics Row -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6">
            <div class="stats-card">
                <div class="stats-icon">
                    <i class="fas fa-tv"></i>
                </div>
                <div class="stats-number">{{ channels|length }}</div>
                <div class="stats-label">Total Channels</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="stats-card">
                <div class="stats-icon">
                    <i class="fas fa-satellite-dish"></i>
                </div>
                <div class="stats-number">{{ channels|selectattr('is_live')|list|length }}</div>
                <div class="stats-label">Live Channels</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="stats-card">
                <div class="stats-icon">
                    <i class="fas fa-globe"></i>
                </div>
                <div class="stats-number">{{ channels|map(attribute='country_code')|unique|list|length }}</div>
                <div class="stats-label">Countries</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="stats-card">
                <div class="stats-icon">
                    <i class="fas fa-layer-group"></i>
                </div>
                <div class="stats-number">{{ channels|map(attribute='category')|unique|list|length }}</div>
                <div class="stats-label">Categories</div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs" id="iptvTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="all-channels-tab" data-bs-toggle="tab" data-bs-target="#all-channels" type="button" role="tab">
                <i class="fas fa-list me-2"></i>All Channels
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button" role="tab">
                <i class="fas fa-signal me-2"></i>Live Channels
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab">
                <i class="fas fa-tags me-2"></i>By Category
            </button>
        </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="iptvTabsContent">
        <!-- All Channels Tab -->
        <div class="tab-pane fade show active" id="all-channels" role="tabpanel">
            <div class="row">
                {% for channel in channels %}
                <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6 mb-4">
                    <div class="channel-card">
                        <div class="channel-logo-container">
                            {% if channel.logo_url %}
                            <img src="{{ channel.logo_url }}" alt="{{ channel.name }}" class="channel-logo" onerror="this.src='https://via.placeholder.com/150x80/303030/FFFFFF?text=No+Logo'">
                            {% else %}
                            <div style="color: #666; font-size: 40px;">
                                <i class="fas fa-tv"></i>
                            </div>
                            {% endif %}
                            <div class="channel-status {{ 'live' if channel.is_live else 'offline' }}"></div>
                            {% if channel.quality %}
                            <div style="position: absolute; bottom: 10px; left: 10px; background-color: rgba(0,0,0,0.8); color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px;">
                                {{ channel.quality }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="channel-info">
                            <div class="channel-name">{{ channel.name }}</div>
                            {% if channel.category %}
                            <div class="channel-category">{{ channel.category }}</div>
                            {% endif %}
                            <div class="channel-meta">
                                <div><i class="fas fa-user me-1"></i> Added by: {{ channel.added_by_name or 'System' }}</div>
                                <div><i class="fas fa-calendar me-1"></i> {{ channel.added_at.strftime('%Y-%m-%d') if channel.added_at else 'N/A' }}</div>
                                {% if channel.country_code %}
                                <div><i class="fas fa-flag me-1"></i> {{ channel.country_code }}</div>
                                {% endif %}
                            </div>
                            <div class="channel-actions">
                                <a href="{{ url_for('iptv_play', channel_id=channel.id) }}" class="channel-action-btn play-btn">
                                    <i class="fas fa-play"></i> Play
                                </a>
                                <button class="channel-action-btn edit-btn" onclick="editChannel({{ channel.id }})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="channel-action-btn delete-btn" onclick="deleteChannel({{ channel.id }}, '{{ channel.name }}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="col-12 text-center py-5">
                    <i class="fas fa-tv fa-4x mb-3" style="color: #404040;"></i>
                    <h4 style="color: var(--youtube-text-secondary);">No channels found</h4>
                    <p class="text-muted">Add your first IPTV channel using the "Add Channel" button</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Live Channels Tab -->
        <div class="tab-pane fade" id="active" role="tabpanel">
            <div class="row">
                {% for channel in channels if channel.is_live %}
                <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6 mb-4">
                    <div class="channel-card">
                        <div class="channel-logo-container">
                            {% if channel.logo_url %}
                            <img src="{{ channel.logo_url }}" alt="{{ channel.name }}" class="channel-logo" onerror="this.src='https://via.placeholder.com/150x80/303030/FFFFFF?text=No+Logo'">
                            {% else %}
                            <div style="color: #666; font-size: 40px;">
                                <i class="fas fa-tv"></i>
                            </div>
                            {% endif %}
                            <div class="channel-status live"></div>
                            {% if channel.quality %}
                            <div style="position: absolute; bottom: 10px; left: 10px; background-color: rgba(0,0,0,0.8); color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px;">
                                {{ channel.quality }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="channel-info">
                            <div class="channel-name">{{ channel.name }}</div>
                            {% if channel.category %}
                            <div class="channel-category">{{ channel.category }}</div>
                            {% endif %}
                            <div class="channel-actions">
                                <a href="{{ url_for('iptv_play', channel_id=channel.id) }}" class="channel-action-btn play-btn" style="width: 100%;">
                                    <i class="fas fa-play me-1"></i> Watch Live
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="col-12 text-center py-5">
                    <i class="fas fa-signal-slash fa-4x mb-3" style="color: #404040;"></i>
                    <h4 style="color: var(--youtube-text-secondary);">No live channels</h4>
                    <p class="text-muted">All channels are currently offline</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Categories Tab -->
        <div class="tab-pane fade" id="categories" role="tabpanel">
            {% set categories = {} %}
            {% for channel in channels %}
                {% set category = channel.category or 'Uncategorized' %}
                {% if category not in categories %}
                    {% set _ = categories.update({category: []}) %}
                {% endif %}
                {% set _ = categories[category].append(channel) %}
            {% endfor %}
            
            {% for category, category_channels in categories.items() %}
            <div class="category-section mb-5">
                <h4 class="section-title mb-3">{{ category }} <span class="badge bg-danger">{{ category_channels|length }}</span></h4>
                <div class="row">
                    {% for channel in category_channels %}
                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="channel-card" style="height: 100%;">
                            <div class="channel-logo-container" style="height: 100px;">
                                {% if channel.logo_url %}
                                <img src="{{ channel.logo_url }}" alt="{{ channel.name }}" class="channel-logo" style="max-height: 60px;" onerror="this.src='https://via.placeholder.com/100x50/303030/FFFFFF?text=TV'">
                                {% else %}
                                <div style="color: #666; font-size: 30px;">
                                    <i class="fas fa-tv"></i>
                                </div>
                                {% endif %}
                                <div class="channel-status {{ 'live' if channel.is_live else 'offline' }}" style="width: 10px; height: 10px;"></div>
                            </div>
                            <div class="channel-info" style="padding: 10px;">
                                <div class="channel-name" style="font-size: 14px;">{{ channel.name|truncate(20) }}</div>
                                <div class="channel-actions" style="margin-top: 10px;">
                                    <a href="{{ url_for('iptv_play', channel_id=channel.id) }}" class="channel-action-btn play-btn" style="padding: 5px; font-size: 11px;">
                                        <i class="fas fa-play"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- M3U Playlist Section -->
    <div class="m3u-section">
        <h4 class="section-title mb-3">IPTV Playlist</h4>
        <p class="text-muted">Generate an M3U playlist file that can be imported into IPTV players like VLC, IPTV Smarters, etc.</p>
        <div class="m3u-info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-file-alt me-2"></i>
                    <strong>Playlist URL:</strong>
                    <span id="playlistUrl">{{ request.host_url }}iptv/generate_m3u</span>
                </div>
                <button class="btn btn-sm btn-danger" onclick="copyPlaylistUrl()">
                    <i class="fas fa-copy me-1"></i> Copy URL
                </button>
            </div>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('generate_m3u') }}" class="btn btn-success">
                <i class="fas fa-download me-2"></i> Download M3U File
            </a>
            <a href="vlc://{{ request.host_url }}iptv/generate_m3u" class="btn btn-primary">
                <i class="fab fa-vlc me-2"></i> Open in VLC
            </a>
        </div>
    </div>

    <!-- Bulk Import Section -->
    <div class="bulk-import-section">
        <h4 class="section-title mb-3">Bulk Import</h4>
        <div class="instructions">
            <p><i class="fas fa-info-circle me-2"></i> You can import multiple channels at once using an M3U file or text in M3U format.</p>
            
            <h6 class="mt-3 mb-2">M3U Format Example:</h6>
            <div class="code-block">
#EXTM3U<br>
#EXTINF:-1 tvg-id="Channel1" tvg-name="BBC News" tvg-logo="https://example.com/bbc.png" group-title="News",BBC News<br>
http://example.com/stream1.m3u8<br>
#EXTINF:-1 tvg-id="Channel2" tvg-name="CNN" tvg-logo="https://example.com/cnn.png" group-title="News",CNN<br>
http://example.com/stream2.m3u8
            </div>
        </div>
        
        <form id="bulkImportForm" onsubmit="return false;">
            <div class="mb-3">
                <label class="form-label">Import Type</label>
                <select class="form-control" id="importType">
                    <option value="m3u">M3U File Upload</option>
                    <option value="text">M3U Text Input</option>
                    <option value="url">M3U URL</option>
                </select>
            </div>
            
            <div id="m3uFileUpload" class="import-section">
                <div class="mb-3">
                    <label class="form-label">Upload M3U File</label>
                    <input type="file" class="form-control" id="m3uFile" accept=".m3u,.m3u8">
                </div>
            </div>
            
            <div id="m3uTextInput" class="import-section" style="display: none;">
                <div class="mb-3">
                    <label class="form-label">Paste M3U Content</label>
                    <textarea class="form-control" id="m3uText" rows="6" placeholder="#EXTM3U&#10;#EXTINF:-1 tvg-name=&quot;Channel Name&quot; group-title=&quot;Category&quot;,Channel Name&#10;http://stream.url"></textarea>
                </div>
            </div>
            
            <div id="m3uUrlInput" class="import-section" style="display: none;">
                <div class="mb-3">
                    <label class="form-label">M3U URL</label>
                    <input type="url" class="form-control" id="m3uUrl" placeholder="https://example.com/playlist.m3u">
                </div>
            </div>
            
            <button class="btn btn-danger" onclick="importChannels()">
                <i class="fas fa-upload me-2"></i> Import Channels
            </button>
        </form>
    </div>
</div>

<!-- Add Channel Modal -->
<div class="modal fade" id="addChannelModal" tabindex="-1" aria-labelledby="addChannelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background-color: var(--youtube-dark); color: white;">
            <div class="modal-header border-bottom">
                <h5 class="modal-title" id="addChannelModalLabel">Add New IPTV Channel</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('iptv_manage') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Channel Name *</label>
                            <input type="text" class="form-control" name="name" required placeholder="e.g., BBC News HD">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Category</label>
                            <input type="text" class="form-control" name="category" placeholder="e.g., News, Sports, Entertainment">
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Stream URL *</label>
                            <input type="url" class="form-control" name="stream_url" required placeholder="http://example.com/stream.m3u8">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Logo URL</label>
                            <input type="url" class="form-control" name="logo_url" placeholder="https://example.com/logo.png">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Quality</label>
                            <select class="form-control" name="quality">
                                <option value="SD">SD</option>
                                <option value="HD" selected>HD</option>
                                <option value="FHD">FHD</option>
                                <option value="4K">4K</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Country Code</label>
                            <input type="text" class="form-control" name="country_code" placeholder="US, UK, etc." maxlength="2">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_live" id="is_live" checked>
                                <label class="form-check-label" for="is_live">
                                    Channel is Live
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Add Channel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Channel Modal -->
<div class="modal fade" id="editChannelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background-color: var(--youtube-dark); color: white;">
            <div class="modal-header border-bottom">
                <h5 class="modal-title">Edit Channel</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editChannelForm">
                <div class="modal-body">
                    <input type="hidden" id="editChannelId" name="id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Channel Name *</label>
                            <input type="text" class="form-control" id="editName" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Category</label>
                            <input type="text" class="form-control" id="editCategory" name="category">
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Stream URL *</label>
                            <input type="url" class="form-control" id="editStreamUrl" name="stream_url" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Logo URL</label>
                            <input type="url" class="form-control" id="editLogoUrl" name="logo_url">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Quality</label>
                            <select class="form-control" id="editQuality" name="quality">
                                <option value="SD">SD</option>
                                <option value="HD">HD</option>
                                <option value="FHD">FHD</option>
                                <option value="4K">4K</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Country Code</label>
                            <input type="text" class="form-control" id="editCountryCode" name="country_code" maxlength="2">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_live" id="editIsLive">
                                <label class="form-check-label" for="editIsLive">
                                    Channel is Live
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Active</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_active" id="editIsActive" checked>
                                <label class="form-check-label" for="editIsActive">
                                    Channel is Active
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Tab functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Show the first tab by default
        const firstTab = new bootstrap.Tab(document.querySelector('#all-channels-tab'));
        firstTab.show();
        
        // Import type toggle
        const importType = document.getElementById('importType');
        const importSections = document.querySelectorAll('.import-section');
        
        importType.addEventListener('change', function() {
            importSections.forEach(section => section.style.display = 'none');
            
            if (this.value === 'm3u') {
                document.getElementById('m3uFileUpload').style.display = 'block';
            } else if (this.value === 'text') {
                document.getElementById('m3uTextInput').style.display = 'block';
            } else if (this.value === 'url') {
                document.getElementById('m3uUrlInput').style.display = 'block';
            }
        });
    });
    
    // Copy playlist URL
    function copyPlaylistUrl() {
        const url = document.getElementById('playlistUrl').textContent;
        navigator.clipboard.writeText(url).then(() => {
            alert('Playlist URL copied to clipboard!');
        });
    }
    
    // Edit channel
    async function editChannel(channelId) {
        try {
            const response = await fetch(`/iptv/channel/${channelId}`);
            if (response.ok) {
                const channel = await response.json();
                
                // Populate form
                document.getElementById('editChannelId').value = channel.id;
                document.getElementById('editName').value = channel.name;
                document.getElementById('editCategory').value = channel.category || '';
                document.getElementById('editStreamUrl').value = channel.stream_url;
                document.getElementById('editLogoUrl').value = channel.logo_url || '';
                document.getElementById('editQuality').value = channel.quality || 'HD';
                document.getElementById('editCountryCode').value = channel.country_code || '';
                document.getElementById('editIsLive').checked = channel.is_live || false;
                document.getElementById('editIsActive').checked = channel.is_active !== false;
                
                // Show modal
                const editModal = new bootstrap.Modal(document.getElementById('editChannelModal'));
                editModal.show();
            } else {
                alert('Failed to load channel data');
            }
        } catch (error) {
            console.error('Error loading channel:', error);
            alert('Error loading channel data');
        }
    }
    
    // Delete channel
    async function deleteChannel(channelId, channelName) {
        if (confirm(`Are you sure you want to delete "${channelName}"?`)) {
            try {
                const response = await fetch(`/iptv/channel/${channelId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    alert('Channel deleted successfully');
                    location.reload();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error || 'Failed to delete channel'}`);
                }
            } catch (error) {
                console.error('Error deleting channel:', error);
                alert('Error deleting channel');
            }
        }
    }
    
    // Import channels
    async function importChannels() {
        const importType = document.getElementById('importType').value;
        let formData = new FormData();
        
        if (importType === 'm3u') {
            const fileInput = document.getElementById('m3uFile');
            if (!fileInput.files.length) {
                alert('Please select an M3U file');
                return;
            }
            formData.append('file', fileInput.files[0]);
        } else if (importType === 'text') {
            const text = document.getElementById('m3uText').value;
            if (!text.trim()) {
                alert('Please enter M3U content');
                return;
            }
            formData.append('text', text);
        } else if (importType === 'url') {
            const url = document.getElementById('m3uUrl').value;
            if (!url.trim()) {
                alert('Please enter M3U URL');
                return;
            }
            formData.append('url', url);
        }
        
        try {
            const response = await fetch('/iptv/import', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                alert(`${result.count} channels imported successfully!`);
                location.reload();
            } else {
                const error = await response.json();
                alert(`Error: ${error.error || 'Failed to import channels'}`);
            }
        } catch (error) {
            console.error('Error importing channels:', error);
            alert('Error importing channels');
        }
    }
    
    // Handle edit form submission
    document.getElementById('editChannelForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        
        // Convert checkbox values
        data.is_live = document.getElementById('editIsLive').checked;
        data.is_active = document.getElementById('editIsActive').checked;
        
        try {
            const response = await fetch('/iptv/channel/' + data.id, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                alert('Channel updated successfully');
                bootstrap.Modal.getInstance(document.getElementById('editChannelModal')).hide();
                location.reload();
            } else {
                const error = await response.json();
                alert(`Error: ${error.error || 'Failed to update channel'}`);
            }
        } catch (error) {
            console.error('Error updating channel:', error);
            alert('Error updating channel');
        }
    });
    
    // Search functionality for channels
    function searchChannels() {
        const searchTerm = document.querySelector('.search-input').value.toLowerCase();
        const channelCards = document.querySelectorAll('.channel-card');
        
        channelCards.forEach(card => {
            const channelName = card.querySelector('.channel-name').textContent.toLowerCase();
            if (channelName.includes(searchTerm)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }
    
    // Attach search to search input
    document.querySelector('.search-input').addEventListener('input', searchChannels);
</script>
{% endblock %}